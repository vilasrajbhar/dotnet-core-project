---
- hosts: windows
  tasks:
    - name: Remove existing ContosoWebApp folder and application
      win_shell: |
        if (Test-Path "C:\inetpub\wwwroot\ContosoWebApp") { Remove-Item -Path "C:\inetpub\wwwroot\ContosoWebApp" -Recurse -Force }
        if (Test-Path "C:\inetpub\wwwroot\ContosoWebApp") { Remove-Item -Path "C:\inetpub\wwwroot\artifacts" -Recurse -Force }
        Remove-WebApplication -Name "ContosoWebApp" -Site "Default Web Site"
        ls "C:\inetpub\wwwroot"
      ignore_errors: yes

    - name: Extract ContosoWebApp.zip
      win_shell: |
        Expand-Archive -Path $env:WORKSPACE\ContosoWebApp.zip -DestinationPath C:\\inetpub\\wwwroot
        Rename-Item -Path "C:\inetpub\wwwroot\artifacts" -NewName "ContosoWebApp"
        ls "C:\inetpub\wwwroot"
        ls "C:\inetpub\wwwroot\ContosoWebApp"
      ignore_errors: yes

    - name: Convert ContosoWebApp folder to IIS WebApplication
      win_shell: ConvertTo-WebApplication -PSPath 'IIS:\\Sites\\Default Web Site\\ContosoWebApp'
